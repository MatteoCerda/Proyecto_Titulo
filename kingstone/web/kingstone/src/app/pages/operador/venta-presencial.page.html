<div class="venta-container" [formGroup]="form">
  <header class="page-header">
    <div>
      <h1>Registrar venta presencial / WhatsApp</h1>
      <p>Busca al cliente por RUT, completa la informaci\xf3n y registra la venta para que aparezca en el calendario.</p>
    </div>
    <button type="button" class="ghost" (click)="limpiar()">Limpiar formulario</button>
  </header>

  <section class="panel">
    <h2>1. B\xfasqueda de cliente</h2>
    <form class="rut-search" (ngSubmit)="buscarRut()">
      <label for="rut-input">RUT del cliente</label>
      <div class="search-row">
        <input id="rut-input" type="text" [formControl]="lookupRut" placeholder="12.345.678-9" />
        <button type="submit" [disabled]="searchLoading()">Buscar</button>
      </div>
    </form>
    <p class="hint">Si el cliente ya tiene RUT registrado, lo vincularemos autom\xe1ticamente. Si no existe, se crear\xe1 como presencial.</p>
    <p class="error" *ngIf="searchError()">{{ searchError() }}</p>
    <div class="result" *ngIf="clienteEncontrado() as resultado">
      <ng-container *ngIf="resultado.found && resultado.cliente; else sinCliente">
        <div class="cliente-data">
          <h3>Cliente encontrado</h3>
          <ul>
            <li><strong>RUT:</strong> {{ resultado.cliente.rut || 'Sin registro' }}</li>
            <li><strong>Nombre:</strong> {{ resultado.cliente.nombre || 'Sin registro' }}</li>
            <li><strong>Correo:</strong> {{ resultado.cliente.email || 'Sin registro' }}</li>
            <li><strong>Tel\xe9fono:</strong> {{ resultado.cliente.telefono || 'Sin registro' }}</li>
            <li><strong>Estado:</strong> {{ resultado.cliente.estado === 'pending_claim' ? 'Pendiente de activaci\xf3n web' : 'Activo' }}</li>
          </ul>
          <div class="alert" *ngIf="resultado.cliente.estado === 'pending_claim'">
            Este cliente necesita que ingrese un c\xf3digo de reclamaci\xf3n al registrarse. Comparte el c\xf3digo generado tras la venta.
          </div>
        </div>
      </ng-container>
      <ng-template #sinCliente>
        <p class="muted">No existe un cliente con ese RUT. Se crear\xe1 un perfil presencial al registrar la venta.</p>
      </ng-template>
    </div>
  </section>

  <section class="panel">
    <h2>2. Datos de la venta</h2>
    <div class="grid">
      <div class="field">
        <label>Canal de venta</label>
        <select formControlName="canal">
          <option value="presencial">Presencial</option>
          <option value="wsp">WhatsApp</option>
        </select>
      </div>
      <div class="field" formGroupName="cliente">
        <label>Nombre del cliente</label>
        <input type="text" formControlName="nombre" placeholder="Nombre y apellido" />
      </div>
      <div class="field" formGroupName="cliente">
        <label>Correo electr\xf3nico</label>
        <input type="email" formControlName="email" placeholder="cliente@correo.cl" />
      </div>
      <div class="field" formGroupName="cliente">
        <label>Tel\xe9fono</label>
        <input type="tel" formControlName="telefono" placeholder="+56 9 xxxx xxxx" />
      </div>
    </div>

    <div class="grid" formGroupName="resumen">
      <div class="field">
        <label>Material / T\xe9cnica</label>
        <input type="text" formControlName="materialLabel" placeholder="Ej: DTF 57 cm" />
      </div>
      <div class="field">
        <label>C\xf3digo material (opcional)</label>
        <input type="text" formControlName="materialId" placeholder="ID inventario o referencia" />
      </div>
      <div class="field">
        <label>Total venta (CLP)</label>
        <input type="number" formControlName="total" min="0" step="100" required />
      </div>
      <div class="field">
        <label>Cantidad de \xedtems</label>
        <input type="number" formControlName="itemsCount" min="1" placeholder="Ej: 3" />
      </div>
      <div class="field">
        <label>Tipo de material</label>
        <select formControlName="dtfCategoria">
          <option value="dtf">DTF</option>
          <option value="textil">Textil</option>
          <option value="uv">UV</option>
          <option value="tela">Tela</option>
          <option value="pvc">PVC</option>
          <option value="sticker">Sticker</option>
          <option value="comprinter">Comprinter</option>
        </select>
      </div>
      <div class="field" *ngIf="form.get('resumen')?.value?.dtfCategoria === 'comprinter'">
        <label>Material Comprinter</label>
        <select formControlName="comprinterMaterial">
          <option value="pvc">PVC</option>
          <option value="pu">PU</option>
        </select>
      </div>
      <div class="field">
        <label>Metros utilizados</label>
        <input type="number" formControlName="dtfMetros" min="0" step="0.1" placeholder="Ej: 2.5" />
      </div>
      <div class="field">
        <label>Cent\xedmetros adicionales</label>
        <input type="number" formControlName="dtfCentimetros" min="0" step="1" placeholder="Ej: 30" />
      </div>
      <div class="full field">
        <label>Notas internas</label>
        <textarea formControlName="note" rows="3" placeholder="Detalles relevantes, instrucciones de producci\xf3n, etc."></textarea>
      </div>
      <div class="toggle-field">
        <input type="checkbox" id="adjunto" formControlName="adjuntoRequerido" />
        <label for="adjunto">Requiere adjuntar archivo DTF</label>
      </div>
    </div>
  </section>

  <section class="panel" formGroupName="agenda">
    <h2>3. Agenda en calendario</h2>
    <p class="muted">Opcional: programa una fecha estimada para que aparezca en el calendario del operador.</p>
    <div class="grid">
      <div class="field">
        <label>Fecha programada</label>
        <input type="date" formControlName="fecha" />
      </div>
      <div class="field">
        <label>Hora</label>
        <input type="time" formControlName="hora" />
      </div>
      <div class="field">
        <label>T\xe9cnica / proceso</label>
        <input type="text" formControlName="tecnica" placeholder="Ej: Impresi\xf3n DTF" />
      </div>
      <div class="field">
        <label>M\xe1quina / recurso</label>
        <input type="text" formControlName="maquina" placeholder="Ej: Plotter dtf 1" />
      </div>
      <div class="full field">
        <label>Notas para producci\xf3n</label>
        <textarea formControlName="notas" rows="2" placeholder="Indicaciones para el equipo de producci\xf3n"></textarea>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>4. Adjuntos</h2>
    <p class="muted">Puedes agregar archivos (m\xe1ximo 10) con dise\xf1os o referencias para el pedido.</p>
    <input type="file" (change)="onAttachmentsSelected($event)" multiple />
    <ul class="files" *ngIf="attachments().length">
      <li *ngFor="let file of attachments()">{{ file.name }} ({{ file.size | number }} bytes)</li>
    </ul>
  </section>

  <section class="panel summary">
    <p class="error" *ngIf="error()">{{ error() }}</p>
    <div class="success" *ngIf="ventaRegistrada() as venta">
      <h3>Venta registrada correctamente</h3>
      <p>Pedido #{{ venta.id }} creado para el cliente.</p>
      <div *ngIf="venta.claimCode">
        <strong>C\xf3digo de reclamaci\xf3n:</strong>
        <span class="claim">{{ venta.claimCode }}</span>
        <p class="muted">Entrega este c\xf3digo al cliente para que active su cuenta web. Expira el {{ venta.claimExpiresAt | date:'dd/MM/yyyy HH:mm' }}.</p>
      </div>
      <div *ngIf="!venta.claimCode && requiereCodigo()">Este cliente ya cuenta con un c\xf3digo vigente. Confirma que lo haya recibido.</div>
    </div>
    <button type="button" class="primary" (click)="registrar()" [disabled]="loading()">
      {{ loading() ? 'Registrando...' : 'Registrar venta' }}
    </button>
  </section>
</div>
