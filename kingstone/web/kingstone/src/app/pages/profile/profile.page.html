<ion-content class="profile-content">
  <div class="profile-layout">
    <aside class="profile-menu">
      <nav>
        <button type="button" [class.active]="tab() === 'datos'" (click)="select('datos')">Datos de la cuenta</button>
        <button *ngIf="isClient()" type="button" [class.active]="tab() === 'pedidos'" (click)="select('pedidos')">Mis pedidos</button>
      </nav>
    </aside>
    <main class="profile-main">
      <ng-container *ngIf="tab() === 'datos'">
        <div class="card">
          <div class="card-head">
            <div class="avatar"><span>{{ (form.value.fullName || auth.getEmail() || '?').slice(0,1).toUpperCase() }}</span></div>
            <div class="head-info">
              <h1>Mi Perfil</h1>
              <p class="muted">{{ form.get('email')?.value }}</p>
            </div>
          </div>

          <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <h3>Información personal</h3>
            <div class="grid">
              <ion-item class="field"><ion-label position="stacked">Correo electrónico</ion-label><ion-input type="email" formControlName="email"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Nombre completo</ion-label><ion-input type="text" formControlName="fullName" placeholder="Tu nombre"></ion-input></ion-item>
            </div>

            <h3>Datos de contacto</h3>
            <div class="grid">
              <ion-item class="field"><ion-label position="stacked">RUT</ion-label><ion-input type="text" [formControl]="clientForm.controls.rut"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Teléfono</ion-label><ion-input type="tel" [formControl]="clientForm.controls.telefono"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Dirección</ion-label><ion-input type="text" [formControl]="clientForm.controls.direccion"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Comuna</ion-label><ion-input type="text" [formControl]="clientForm.controls.comuna"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Ciudad</ion-label><ion-input type="text" [formControl]="clientForm.controls.ciudad"></ion-input></ion-item>
            </div>

            <div class="actions">
              <ion-button type="submit" [disabled]="form.invalid || loading()">Guardar perfil</ion-button>
              <ion-button color="medium" fill="outline" (click)="logout()">Cerrar sesión</ion-button>
            </div>
          </form>
        </div>

        <div class="card">
          <h3>Cambiar contraseña</h3>
          <form [formGroup]="passForm" (ngSubmit)="onSubmitPassword()">
            <div class="grid">
              <ion-item class="field"><ion-label position="stacked">Contraseña actual</ion-label><ion-input type="password" formControlName="currentPassword" placeholder="Tu contraseña actual"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Nueva contraseña</ion-label><ion-input type="password" formControlName="newPassword" placeholder="Mínimo 6 caracteres"></ion-input></ion-item>
              <ion-item class="field"><ion-label position="stacked">Confirmar nueva contraseña</ion-label><ion-input type="password" formControlName="confirmNewPassword" placeholder="Repite la nueva contraseña"></ion-input></ion-item>
            </div>
            <div class="actions">
              <ion-button type="submit" [disabled]="passForm.invalid || loading()">Actualizar contraseña</ion-button>
            </div>
          </form>
        </div>
      </ng-container>

      <ng-container *ngIf="isClient() && tab() === 'pedidos'">
        <div class="card" id="orders-section">
          <div class="card-head-simple">
            <h3>Mis pedidos</h3>
            <div class="header-actions">
              <ion-button fill="outline" color="primary" (click)="refreshOrders()">Actualizar</ion-button>
              <ion-button fill="outline" color="medium" routerLink="/cliente/metodos-pago">Métodos de pago</ion-button>
              <ion-button color="primary" routerLink="/crea-tu-diseno">Nuevo pedido</ion-button>
            </div>
          </div>

          <section class="notice" *ngIf="loadingOrders()">Cargando tus pedidos...</section>
          <section class="notice error" *ngIf="errorOrders()">{{ errorOrders() }}</section>

          <section class="orders" *ngIf="orders().length > 0">
            <article class="order" *ngFor="let order of orders()">
              <header>
                <div>
                  <strong>{{ mainItemOf(order)?.name || 'Pedido personalizado' }}</strong>
                  <small>Creado el {{ order.createdAt | date:'dd/MM/yyyy HH:mm' }}</small>
                </div>
                <div class="order-header-actions">
                  <ion-button *ngIf="canDownloadReceipt(order)" fill="clear" size="small" (click)="downloadReceipt(order)">
                    Boleta
                  </ion-button>
                  <ion-button fill="clear" size="small" (click)="toggleOrder(order.id)">
                    {{ expandedId() === order.id ? 'Ocultar' : 'Ver detalle' }}
                  </ion-button>
                </div>
              </header>
              <div class="order-summary">
                <div class="summary-block total-block">
                  <span>Total</span>
                  <strong>{{ formatCurrency(totalAmountOf(order)) }}</strong>
                </div>
                <div class="summary-block state-block" [class.rejected]="order.estado === 'RECHAZADO'">
                  <span>Estado</span>
                  <strong>{{ labelEstado(order.estado) }}</strong>
                  <small *ngIf="readyStageLabel(order)">{{ readyStageLabel(order) }}</small>
                </div>
                <div class="summary-block material-block" *ngIf="materialOf(order)">
                  <span>Material</span>
                  <strong>{{ materialOf(order) }}</strong>
                </div>
                <div class="summary-block product-block" *ngIf="mainItemOf(order) as main">
                  <span>Productos</span>
                  <strong>{{ main.name }}</strong>
                  <small>{{ main.detail }}</small>
                </div>
                <div class="summary-block ready-block" *ngIf="readyDateOf(order)">
                  <span>{{ order.estado === 'COMPLETADO' ? 'Entregado' : 'Entrega estimada' }}</span>
                  <strong>{{ readyDateOf(order) | date:'dd/MM/yyyy HH:mm' }}</strong>
                  <small *ngIf="readyStageLabel(order)">{{ readyStageLabel(order) }}</small>
                </div>
                <div class="summary-block pickup-block" *ngIf="readyPickupLabel(order)">
                  <span>Retiro</span>
                  <strong>{{ readyPickupLabel(order) }}</strong>
                </div>
              </div>
              <div class="order-body" *ngIf="expandedId() === order.id">
                <section class="order-section" *ngIf="noteOf(order)">
                  <h4>Notas del pedido</h4>
                  <p class="note-text">{{ noteOf(order) }}</p>
                </section>
                <div class="order-actions">
                  <ion-button fill="outline" color="medium" (click)="openTransferModal(order)" *ngIf="canPay(order)">
                    Transferencia
                  </ion-button>
                  <ion-button color="primary" (click)="payOrder(order)" *ngIf="canPay(order)" [disabled]="isPaying(order)">
                    <ion-spinner *ngIf="isPaying(order)" name="lines-small"></ion-spinner>
                    <span *ngIf="!isPaying(order)">Pagar con Webpay</span>
                    <span *ngIf="isPaying(order)">Redirigiendo...</span>
                  </ion-button>
                  <small *ngIf="canPay(order)">Seras redirigido a Webpay para ingresar la tarjeta de prueba.</small>
                </div>
                <section class="order-section transfer-section" *ngIf="transferPaymentOf(order) as transfer">
                  <h4>Pago por transferencia</h4>
                  <div class="transfer-status" [class.pending]="transfer.status === 'pending'" [class.approved]="transfer.status === 'approved'" [class.rejected]="transfer.status === 'rejected'">
                    {{ transferStatusLabel(transfer.status) }}
                  </div>
                  <p class="note-text" *ngIf="transfer.notes">{{ transfer.notes }}</p>
                  <p class="note-text operator-note" *ngIf="transfer.operator?.note">
                    Operador: {{ transfer.operator.note }}
                  </p>
                  <small *ngIf="transferSubmittedAt(transfer) as submitted; else pendingTransfer">
                    Enviado el {{ submitted | date:'dd/MM/yyyy HH:mm' }}
                  </small>
                  <ng-template #pendingTransfer>
                    <small>Registro recibido.</small>
                  </ng-template>
                </section>
                <section class="order-section" *ngIf="operatorDecisionOf(order) as decision">
                  <h4>Resoluci&oacute;n del operador</h4>
                  <p class="note-text">{{ decision.reason }}</p>
                  <small *ngIf="decision.decidedAt">Registrado el {{ decision.decidedAt | date:'dd/MM/yyyy HH:mm' }}</small>
                </section>
                <section class="order-section" *ngIf="productsOf(order).length">
                  <h4>Productos del catalogo</h4>
                  <ul>
                    <li *ngFor="let product of productsOf(order)">
                      <strong>{{ product.name || 'Producto' }}</strong>
                      <span>Cantidad: {{ product.quantity || 0 }}</span>
                      <span *ngIf="product.price">Precio unitario: {{ product.price | currency:'CLP':'symbol-narrow':'1.0-0' }}</span>
                    </li>
                  </ul>
                </section>
                <section class="order-section" *ngIf="quoteItemsOf(order).length">
                  <h4>Detalle de cotizacion</h4>
                  <ul>
                    <li *ngFor="let item of quoteItemsOf(order)">
                      <strong>{{ item.name }}</strong>
                      <span>Cantidad: {{ item.quantity }}</span>
                      <span *ngIf="item.widthCm && item.heightCm">Dimensiones: {{ item.widthCm }} x {{ item.heightCm }} cm</span>
                    </li>
                  </ul>
                </section>
                <section class="order-section" *ngIf="attachmentsOf(order).length">
                  <h4>Archivos adjuntos</h4>
                  <ul>
                    <li *ngFor="let file of attachmentsOf(order)">
                      <div class="file-line">
                        <strong>{{ file.filename }}</strong>
                        <span *ngIf="file.areaCm2">Area: {{ file.areaCm2 | number:'1.0-0' }} cm2</span>
                        <span *ngIf="file.lengthCm">Largo: {{ file.lengthCm | number:'1.0-1' }} cm</span>
                        <span *ngIf="file.createdAt">{{ file.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                      </div>
                    </li>
                  </ul>
                </section>
              </div>
            </article>
          </section>

          <section class="empty" *ngIf="!loadingOrders() && !errorOrders() && orders().length === 0">
            Aún no tienes pedidos.
          </section>
        </div>
      </ng-container>
    </main>
  </div>

  <div class="transfer-modal-backdrop" *ngIf="transferModalOpen()" (click)="closeTransferModal()">
    <div class="transfer-modal" (click)="$event.stopPropagation()">
      <header>
        <div>
          <h3>Datos para transferencia</h3>
          <p>Sube el comprobante para que validemos tu pago.</p>
        </div>
        <button type="button" class="ghost" (click)="closeTransferModal()">Cerrar</button>
      </header>
      <section class="bank-info" *ngIf="transferInfo() as info; else bankFallback">
        <ul>
          <li><span>Banco</span><strong>{{ info.bankName }}</strong></li>
          <li><span>Nombre</span><strong>{{ info.accountName }}</strong></li>
          <li><span>RUT</span><strong>{{ info.accountRut }}</strong></li>
          <li><span>Tipo</span><strong>{{ info.accountType }}</strong></li>
          <li><span>Número</span><strong>{{ info.accountNumber }}</strong></li>
        </ul>
        <p class="muted" *ngIf="info.instructions">{{ info.instructions }}</p>
      </section>
      <ng-template #bankFallback>
        <p class="muted">No pudimos cargar los datos bancarios. Intenta nuevamente en unos segundos.</p>
      </ng-template>
      <form [formGroup]="transferForm" (ngSubmit)="submitTransferNotification()" class="transfer-form">
        <label>Monto transferido</label>
        <input type="number" formControlName="amount" placeholder="$" />
        <label>N&uacute;mero de operaci&oacute;n</label>
        <input type="text" formControlName="operationNumber" placeholder="Identificador del banco" />
        <label>Fecha y hora</label>
        <input type="datetime-local" formControlName="transferDate" />
        <label>Comentarios para el operador (opcional)</label>
        <textarea rows="2" formControlName="notes" placeholder="Ej: Comprobante adjunto desde mi banco"></textarea>
        <label>Comprobante (PDF o imagen)</label>
        <input type="file" (change)="onTransferFileChange($event)" accept=".pdf,image/png,image/jpeg" />
        <div class="form-error" *ngIf="transferError()">{{ transferError() }}</div>
        <div class="transfer-actions">
          <button type="button" class="ghost" (click)="closeTransferModal()" [disabled]="transferSubmitting()">Cancelar</button>
          <button type="submit" class="primary" [disabled]="transferSubmitting()">
            <ion-spinner *ngIf="transferSubmitting()" name="lines-small"></ion-spinner>
            <span *ngIf="!transferSubmitting()">Enviar comprobante</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</ion-content>




